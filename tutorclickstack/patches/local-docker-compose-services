otel-collector:
  image: {{HDX_IMAGE_REPO}}/{{OTEL_COLLECTOR_IMAGE_NAME_DOCKERHUB}}:{{HYPERDX_IMAGE_VERSION}}
  environment:
    CLICKHOUSE_ENDPOINT: "tcp://clickhouse:9000?dial_timeout=10s"
    CLICKHOUSE_USER: {{HYPERDX_OTEL_EXPORTER_CLICKHOUSE_USERNAME}}
    CLICKHOUSE_PASSWORD: {{HYPERDX_OTEL_EXPORTER_CLICKHOUSE_PASSWORD}}
    HYPERDX_OTEL_EXPORTER_CLICKHOUSE_DATABASE: {{HYPERDX_OTEL_EXPORTER_CLICKHOUSE_DATABASE}}
    HYPERDX_LOG_LEVEL: {{HYPERDX_LOG_LEVEL}}
    OPAMP_SERVER_URL: "http://hyperdx:{{HYPERDX_OPAMP_PORT}}"
  ports:
    - "13133:13133" # health_check extension
    - "24225:24225" # fluentd receiver
    - "4317:4317" # OTLP gRPC receiver
    - "4318:4318" # OTLP http receiver
    - "8888:8888" # metrics extension
  restart: always
  depends_on:
    - clickhouse

hyperdx:
  image: {{HDX_IMAGE_REPO}}/{{HYPERDX_IMAGE_NAME_DOCKERHUB}}:{{HYPERDX_IMAGE_VERSION}}
  ports:
    - {{HYPERDX_API_PORT}}:{{HYPERDX_API_PORT}}
    - {{HYPERDX_APP_PORT}}:{{HYPERDX_APP_PORT}}
  environment:
    FRONTEND_URL: {{HYPERDX_APP_URL}}:{{HYPERDX_APP_PORT}}
    HYPERDX_API_KEY: {{HYPERDX_API_KEY}}
    HYPERDX_API_PORT: {{HYPERDX_API_PORT}}
    HYPERDX_APP_PORT: {{HYPERDX_APP_PORT}}
    HYPERDX_APP_URL: {{HYPERDX_APP_URL}}
    HYPERDX_LOG_LEVEL: {{HYPERDX_LOG_LEVEL}}
    MINER_API_URL: "http://miner:5123"
    MONGO_URI: "mongodb://mongodb:27017/hyperdx"
    SERVER_URL: http://hyperdx:{{HYPERDX_API_PORT}}
    OPAMP_PORT: {{HYPERDX_OPAMP_PORT}}
    OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4318"
    OTEL_SERVICE_NAME: "hdx-oss-app"
    USAGE_STATS_ENABLED: {{USAGE_STATS_ENABLED}}
    DEFAULT_CONNECTIONS: '[{"name":"Local ClickHouse","host":"http://clickhouse:8123","username":"{{HYPERDX_OTEL_EXPORTER_CLICKHOUSE_USERNAME}}","password":"{{HYPERDX_OTEL_EXPORTER_CLICKHOUSE_PASSWORD}}"}]'
    DEFAULT_SOURCES:
      '[{"from":{"databaseName":"{{HYPERDX_OTEL_EXPORTER_CLICKHOUSE_DATABASE}}","tableName":"otel_logs"},"kind":"log","timestampValueExpression":"TimestampTime","name":"Logs","displayedTimestampValueExpression":"Timestamp","implicitColumnExpression":"Body","serviceNameExpression":"ServiceName","bodyExpression":"Body","eventAttributesExpression":"LogAttributes","resourceAttributesExpression":"ResourceAttributes","defaultTableSelectExpression":"Timestamp,ServiceName,SeverityText,Body","severityTextExpression":"SeverityText","traceIdExpression":"TraceId","spanIdExpression":"SpanId","connection":"Local
      ClickHouse","traceSourceId":"Traces","sessionSourceId":"Sessions","metricSourceId":"Metrics"},{"from":{"databaseName":"{{HYPERDX_OTEL_EXPORTER_CLICKHOUSE_DATABASE}}","tableName":"otel_traces"},"kind":"trace","timestampValueExpression":"Timestamp","name":"Traces","displayedTimestampValueExpression":"Timestamp","implicitColumnExpression":"SpanName","serviceNameExpression":"ServiceName","bodyExpression":"SpanName","eventAttributesExpression":"SpanAttributes","resourceAttributesExpression":"ResourceAttributes","defaultTableSelectExpression":"Timestamp,ServiceName,StatusCode,round(Duration/1e6),SpanName","traceIdExpression":"TraceId","spanIdExpression":"SpanId","durationExpression":"Duration","durationPrecision":9,"parentSpanIdExpression":"ParentSpanId","spanNameExpression":"SpanName","spanKindExpression":"SpanKind","statusCodeExpression":"StatusCode","statusMessageExpression":"StatusMessage","connection":"Local
      ClickHouse","logSourceId":"Logs","sessionSourceId":"Sessions","metricSourceId":"Metrics"},{"from":{"databaseName":"{{HYPERDX_OTEL_EXPORTER_CLICKHOUSE_DATABASE}}","tableName":""},"kind":"metric","timestampValueExpression":"TimeUnix","name":"Metrics","resourceAttributesExpression":"ResourceAttributes","metricTables":{"gauge":"otel_metrics_gauge","histogram":"otel_metrics_histogram","sum":"otel_metrics_sum","_id":"682586a8b1f81924e628e808","id":"682586a8b1f81924e628e808"},"connection":"Local
      ClickHouse","logSourceId":"Logs","traceSourceId":"Traces","sessionSourceId":"Sessions"},{"from":{"databaseName":"{{HYPERDX_OTEL_EXPORTER_CLICKHOUSE_DATABASE}}","tableName":"hyperdx_sessions"},"kind":"session","timestampValueExpression":"TimestampTime","name":"Sessions","displayedTimestampValueExpression":"Timestamp","implicitColumnExpression":"Body","serviceNameExpression":"ServiceName","bodyExpression":"Body","eventAttributesExpression":"LogAttributes","resourceAttributesExpression":"ResourceAttributes","defaultTableSelectExpression":"Timestamp,ServiceName,SeverityText,Body","severityTextExpression":"SeverityText","traceIdExpression":"TraceId","spanIdExpression":"SpanId","connection":"Local
      ClickHouse","logSourceId":"Logs","traceSourceId":"Traces","metricSourceId":"Metrics"}]'
  depends_on:
    - clickhouse
    - mongodb
